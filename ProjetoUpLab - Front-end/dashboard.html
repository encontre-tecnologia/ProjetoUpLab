<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - ReMarket</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 flex min-h-screen">

  <aside id="sidebar" class="bg-green-800 text-white w-64 fixed top-0 left-0 h-full shadow-lg z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
    <div class="flex items-center justify-center space-x-3 p-4 border-b border-green-700 h-20">
      <span class="text-3xl">‚ôªÔ∏è</span>
      <h1 class="text-2xl font-semibold">ReMarket</h1>
    </div>
    <nav class="flex flex-col p-4 space-y-2">
      <a href="dashboard.html" class="flex items-center space-x-3 text-white bg-green-700 px-3 py-2.5 rounded-md font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        <span>Dashboard</span>
      </a>
      <a href="index.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span>Home</span>
      </a>
      <a href="register.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Cadastrar Recurso</span>
      </a>
      <a href="profile.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A10.97 10.97 0 0112 15c2.21 0 4.254.64 5.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <span>Profile</span>
      </a>
      <a href="conversas.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16h6m-7 4h8a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        <span>Minhas Conversas</span>
      </a>
    </nav>
  </aside>

  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-30 hidden lg:hidden"></div>

  <header class="bg-white shadow-md py-4 lg:hidden fixed top-0 left-0 right-0 z-20">
    <div class="container mx-auto flex justify-between items-center px-4">
      <div class="flex items-center space-x-3">
        <span class="text-2xl">‚ôªÔ∏è</span>
        <h1 class="text-xl font-semibold text-green-700">ReMarket</h1>
      </div>
      <button id="sidebar-toggle" class="text-gray-600 hover:text-green-600 focus:outline-none" aria-label="Abrir menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
      </button>
    </div>
  </header>

  <div class="flex-1 flex flex-col lg:ml-64 w-full pt-20 lg:pt-0">
  
    <header class="hidden lg:flex items-center bg-white p-4 border-b border-gray-200 h-20 shadow-sm">
      <h1 class="text-xl font-semibold text-gray-800">Dashboard de Impacto</h1>
    </header>
    
    <main class="flex-grow">
      <div class="container mx-auto px-4 sm:px-6 py-10">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800">Ol√°, <span id="user-name">Usu√°rio</span>!</h2>
            <p class="text-gray-600 mt-1">Veja o resumo do seu impacto positivo na plataforma.</p>
        </div>
    
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                <span class="text-5xl mb-3">üì¶</span>
                <h3 class="text-lg font-semibold text-gray-600">Recursos Cadastrados</h3>
                <p id="total-recursos" class="text-4xl font-bold text-green-600 mt-1">0</p>
                <p class="text-sm text-gray-500 mt-1">itens totais</p>
            </div>
    
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center">
                <span class="text-5xl mb-3">üåç</span>
                <h3 class="text-lg font-semibold text-gray-600">Redu√ß√£o de CO‚ÇÇ Estimada</h3>
                <p id="co2-reduzido" class="text-4xl font-bold text-green-600 mt-1">0 kg</p>
                
                <hr class="w-full my-4 border-gray-200">
    
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Isso √© equivalente a:</h4>
                
                <div class="w-full text-left space-y-3">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üå≥</span>
                        <div class="text-sm">
                            <span id="equiv-arvores" class="font-bold text-green-700">0</span>
                            <span class="text-gray-600"> √°rvores absorvendo CO‚ÇÇ por 1 ano.</span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üöó</span>
                        <div class="text-sm">
                            <span id="equiv-km" class="font-bold text-green-700">0 km</span>
                            <span class="text-gray-600"> evitados em um carro de passeio.</span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üì±</span>
                        <div class="text-sm">
                            <span id="equiv-celular" class="font-bold text-green-700">0</span>
                            <span class="text-gray-600"> cargas completas de smartphone.</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex items-center mb-4">
                    <span class="text-3xl mr-3">üìä</span>
                    <h3 class="text-lg font-semibold text-gray-600">Recursos por Categoria</h3>
                </div>
                <div id="categorias-lista" class="mt-4 space-y-3">
                    <p class="text-gray-500 text-center">Carregando dados...</p>
                </div>
            </div>
    
        </div>
      </div>
    </main>

    <footer class="bg-green-800 text-white text-center py-4 mt-auto">
      <p class="text-sm">&copy; 2025 ReMarket Sustent√°vel ‚Äî Um futuro mais verde üå±</p>
    </footer>

  </div>

<script>
  // Script para controle da Sidebar no mobile
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebar-toggle');
  const sidebarOverlay = document.getElementById('sidebar-overlay');

  const toggleSidebar = () => {
    sidebar.classList.toggle('-translate-x-full');
    sidebar.classList.toggle('translate-x-0');
    sidebarOverlay.classList.toggle('hidden');
  };

  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', toggleSidebar);
  }
  if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', toggleSidebar);
  }
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCexikls640kZgxsknXUQpHZiNEPwRf4xg",
    authDomain: "encurta-c3642.firebaseapp.com",
    projectId: "encurta-c3642",
    storageBucket: "encurta-c3642.firebasestorage.app",
    messagingSenderId: "365232410104",
    appId: "1:365232410104:web:d67b449427153593ec5a0d",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  // Elementos do DOM para atualizar
  const userNameEl = document.getElementById('user-name');
  const totalRecursosEl = document.getElementById('total-recursos');
  const co2ReduzidoEl = document.getElementById('co2-reduzido');
  const categoriasListaEl = document.getElementById('categorias-lista');
  const equivArvoresEl = document.getElementById('equiv-arvores');
  const equivKmEl = document.getElementById('equiv-km');
  const equivCelularEl = document.getElementById('equiv-celular');

  // Fatores de convers√£o (estimativas)
  const CO2_POR_ARVORE_ANO = 22; // kg de CO2 que uma √°rvore adulta absorve em um ano
  const CO2_POR_KM_CARRO = 0.15; // kg de CO2 emitido por km de um carro de passeio m√©dio
  const CO2_POR_CARGA_CELULAR = 0.004; // kg de CO2 por uma carga completa de smartphone

  // L√≥gica de c√°lculo de CO2 (valores de exemplo em kg por item)
  const co2SavingsPerCategory = {
    'M√≥veis': 50,
    'Eletr√¥nicos': 25,
    'Equipamentos': 120,
    'Ve√≠culos': 1500,
    'Pl√°sticos': 6,
    'Metais': 70,
    'T√™xteis': 10,
    'Outros': 5 
  };

  async function loadDashboardData(user) {
    if (!user) return;

    userNameEl.textContent = user.displayName || 'Usu√°rio';

    try {
      const q = query(collection(db, "produtos"), where("usuarioId", "==", user.uid));
      const querySnapshot = await getDocs(q);

      let totalRecursos = 0;
      let totalCo2Saved = 0;
      const categoryCounts = {};

      querySnapshot.forEach(doc => {
        const produto = doc.data();
        const quantidade = produto.quantidade || 1;
        const categoria = produto.categoria;

        totalRecursos += quantidade;
        const co2PerItem = co2SavingsPerCategory[categoria] || co2SavingsPerCategory['Outros'];
        totalCo2Saved += co2PerItem * quantidade;
        categoryCounts[categoria] = (categoryCounts[categoria] || 0) + quantidade;
      });

      // Atualiza os cards com os dados calculados
      totalRecursosEl.textContent = totalRecursos;
      co2ReduzidoEl.textContent = `${totalCo2Saved.toLocaleString('pt-BR', { maximumFractionDigits: 0 })} kg`;
      
      // Calcula e exibe os equivalentes de CO2
      const arvoresEquivalentes = totalCo2Saved / CO2_POR_ARVORE_ANO;
      const kmCarroEvitados = totalCo2Saved / CO2_POR_KM_CARRO;
      const cargasCelular = totalCo2Saved / CO2_POR_CARGA_CELULAR;

      equivArvoresEl.textContent = arvoresEquivalentes.toFixed(1);
      equivKmEl.textContent = `${kmCarroEvitados.toLocaleString('pt-BR', { maximumFractionDigits: 0 })} km`;
      equivCelularEl.textContent = cargasCelular.toLocaleString('pt-BR', { maximumFractionDigits: 0 });

      renderCategoryList(categoryCounts);

    } catch (error)
      {
      console.error("Erro ao buscar dados do dashboard:", error);
      categoriasListaEl.innerHTML = `<p class="text-red-500">N√£o foi poss√≠vel carregar os dados.</p>`;
    }
  }

  function renderCategoryList(categories) {
    categoriasListaEl.innerHTML = ''; 
    
    if (Object.keys(categories).length === 0) {
        categoriasListaEl.innerHTML = `<p class="text-gray-500 text-center">Nenhum recurso cadastrado ainda.</p>`;
        return;
    }

    const sortedCategories = Object.entries(categories).sort(([,a],[,b]) => b-a);

    for (const [categoria, count] of sortedCategories) {
        const itemHtml = `
            <div class="flex justify-between items-center text-sm">
                <span class="font-medium text-gray-700">${categoria}</span>
                <span class="font-bold text-green-700 bg-green-100 px-2 py-1 rounded-full">${count}</span>
            </div>
        `;
        categoriasListaEl.innerHTML += itemHtml;
    }
  }

  onAuthStateChanged(auth, (user) => {
    if (user) {
      loadDashboardData(user);
    } else {
      console.log("Usu√°rio n√£o logado. Redirecionando...");
      // window.location.href = 'login.html'; // Descomente para for√ßar o login se necess√°rio
      userNameEl.textContent = 'Visitante';
      totalRecursosEl.textContent = '0';
      co2ReduzidoEl.textContent = '0 kg';
      categoriasListaEl.innerHTML = `<p class="text-gray-500 text-center">Fa√ßa login para ver seus dados.</p>`;
    }
  });
</script>

</body>
</html>