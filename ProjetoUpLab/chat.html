<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ReMarket Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .error { color: #ef4444; font-size: 0.875rem; text-align: center; margin-top: 0.5rem; }
    #chat-container::-webkit-scrollbar {
      width: 6px;
    }
    #chat-container::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    #chat-container::-webkit-scrollbar-thumb {
      background: #a1a1aa;
      border-radius: 10px;
    }
    #chat-container::-webkit-scrollbar-thumb:hover {
      background: #71717a;
    }
    .break-words {
      word-break: break-word;
      overflow-wrap: break-word;
    }
  </style>
</head>
<body class="bg-gray-50 flex min-h-screen text-gray-900">

  <aside id="sidebar" class="bg-green-800 text-white w-64 fixed top-0 left-0 h-full shadow-lg z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
    <div class="flex items-center justify-center space-x-3 p-4 border-b border-green-700 h-20">
      <span class="text-3xl">‚ôªÔ∏è</span>
      <h1 class="text-2xl font-semibold">ReMarket</h1>
    </div>
    <nav class="flex flex-col p-4 space-y-2">
      <a href="index.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        <span>Home</span>
      </a>
      <a href="register.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span>Cadastrar Recurso</span>
      </a>
      <a href="profile.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A10.97 10.97 0 0112 15c2.21 0 4.254.64 5.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <span>Profile</span>
      </a>
      <a href="conversas.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16h6m-7 4h8a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        <span>Minhas Conversas</span>
      </a>
    </nav>
  </aside>

  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-30 hidden lg:hidden"></div>

  <header class="bg-white shadow-md py-4 lg:hidden fixed top-0 left-0 right-0 z-20">
    <div class="container mx-auto flex justify-between items-center px-4">
      <div class="flex items-center space-x-3">
        <span class="text-2xl">‚ôªÔ∏è</span>
        <h1 class="text-xl font-semibold text-green-700">ReMarket</h1>
      </div>
      <button id="sidebar-toggle" class="text-gray-600 hover:text-green-600 focus:outline-none" aria-label="Abrir menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
      </button>
    </div>
  </header>

  <div class="flex-1 flex flex-col lg:ml-64 w-full pt-20 lg:pt-0">
  
    <header class="hidden lg:flex items-center bg-white p-4 border-b border-gray-200 h-20 shadow-sm">
      <h1 class="text-xl font-semibold text-gray-800">Chat</h1>
    </header>
    <main class="flex flex-col items-center justify-center flex-grow p-4">

<div class="w-full max-w-lg bg-white rounded-2xl shadow-xl flex flex-col" style="height: 600px;">

<div class="bg-green-700 text-white p-4 rounded-t-2xl shadow-md z-10">
  <div class="flex items-center gap-4">
    
    <img id="user-avatar" class="w-10 h-10 rounded-full object-cover border-2 border-white" src="" alt="Avatar" style="display: none;">
    <div class="flex flex-col">
      <h1 id="chat-title" class="text-xl font-bold">ReMarket Chat</h1>
      <div id="typing-indicator" class="text-sm text-white opacity-80 mt-1 hidden">Digitando...</div>
    </div>
  </div>
</div>


        <div id="chat-container" class="p-4 overflow-y-auto max-h-[80vh] flex flex-col gap-4 flex-grow w-full" aria-live="polite">
          <p class="text-gray-500 text-center">Carregando mensagens...</p>
        </div>

        <div id="mensagem-box" class="p-4 border-t border-gray-200 hidden">
          <div class="relative flex items-center">
            <input type="text" id="message-input" placeholder="Digite sua mensagem..." maxlength="500" class="w-full p-3 pr-14 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500 transition-shadow" aria-label="Digite sua mensagem">
            <button id="send-button" class="absolute right-2 bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-green-700 transition-colors" aria-label="Enviar mensagem">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
          </div>
          <div class="flex justify-between items-center mt-1 px-2">
            <p id="error-message" class="error !m-0 !text-left"></p>
            <p id="char-counter" class="text-xs text-gray-500 ml-auto">0 / 500</p>
          </div>
        </div>
      </div>

    </main>

    <footer class="bg-green-800 text-white text-center py-4">
      <p class="text-sm">&copy; 2025 ReMarket Sustent√°vel ‚Äî Um futuro mais verde üå±</p>
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCexikls640kZgxsknXUQpHZiNEPwRf4xg",
      authDomain: "encurta-c3642.firebaseapp.com",
      projectId: "encurta-c3642",
      storageBucket: "encurta-c3642.appspot.com",
      messagingSenderId: "365232410104",
      appId: "1:365232410104:web:d67b449427153593ec5a0d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const chatContainer = document.getElementById('chat-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const mensagemBox = document.getElementById('mensagem-box');
    const chatTitle = document.getElementById('chat-title');
    const avatar = document.getElementById('user-avatar');
    const errorMessage = document.getElementById('error-message');
    const typingIndicator = document.getElementById('typing-indicator'); // <-- Vari√°vel declarada
    const charCounter = document.getElementById('char-counter');

    let currentUser = null;
    let socket = null;
    
    let reconnectAttempts = 0;
    let chatIdStored = null;
    const maxReconnectAttempts = 3;

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.classList.remove('hidden');
      setTimeout(() => errorMessage.classList.add('hidden'), 5000);
    }

    function renderMessage(msg) {
      const div = document.createElement('div');
      const isMy = msg.from === currentUser.uid;
      div.className = `max-w-xs md:max-w-md p-3 rounded-lg ${isMy ? 'bg-green-100 self-end' : 'bg-gray-200 self-start'} break-words`;

      div.innerHTML = `
        <p class="text-sm font-semibold">${msg.fromName || 'Usu√°rio'}</p>
        <p class="text-sm break-words">${msg.text}</p>
        <p class="text-xs text-gray-500 mt-1">${new Date(msg.timestamp).toLocaleTimeString()}</p>
      `;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function abrirConversa(uidDest, nomeDest, nomeProd, prodId, fotoDest = '') {
      if (socket) socket.close();

      const otherUserDoc = await getDoc(doc(db, 'users', uidDest));
      let otherName = nomeDest;
      let otherPhoto = fotoDest;

      if (otherUserDoc.exists()) {
        const otherData = otherUserDoc.data();
        otherName = otherData.name || nomeDest;
        otherPhoto = otherData.photoURL || fotoDest;
      }

      chatTitle.textContent = otherName;
      if (otherPhoto) {
        avatar.src = otherPhoto;
        avatar.style.display = 'block';
      } else {
        avatar.style.display = 'none';
      }

      mensagemBox.classList.remove('hidden');
      chatContainer.innerHTML = '<p class="text-gray-500 text-center">Carregando mensagens...</p>';

      const participants = [currentUser.uid, uidDest].sort();
      chatIdStored = participants.join('-');

      function connectWS() {
        socket = new WebSocket(`ws://localhost:8080?chatId=${chatIdStored}`);

        socket.onopen = () => {
          reconnectAttempts = 0;
          chatContainer.innerHTML = '';
        };

        socket.onmessage = (evt) => {
          const data = JSON.parse(evt.data);

          if (data.error) return showError(data.error);

          // üëá Eventos de digita√ß√£o: trata e sai (L√ìGICA CORRIGIDA)
          if (data.type === 'typing' && data.from !== currentUser.uid) {
            typingIndicator.classList.remove('hidden');
            return;
          }

          if (data.type === 'stopTyping' && data.from !== currentUser.uid) {
            typingIndicator.classList.add('hidden');
            return;
          }

          if (Array.isArray(data)) {
            chatContainer.innerHTML = '';
            data.forEach(msg => {
              renderMessage(msg);
              atualizarAvatarSeForDoOutro(msg);
            });
            return;
          }

          renderMessage(data);
          atualizarAvatarSeForDoOutro(data);
        };

        function atualizarAvatarSeForDoOutro(msg) {
          if (!msg || msg.from === currentUser.uid) return;

          if (msg.fromPhotoURL) {
            avatar.src = msg.fromPhotoURL;
            avatar.style.display = 'block';
          } else {
            avatar.style.display = 'none';
          }

          if (msg.fromName) {
            chatTitle.textContent = msg.fromName;
          }
        }

        socket.onclose = () => {
          if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            showError(`Conex√£o perdida. Tentando reconectar (${reconnectAttempts}/${maxReconnectAttempts})...`);
            setTimeout(connectWS, 3000);
          } else {
            showError('N√£o foi poss√≠vel conectar ao servidor. Recarregue a p√°gina.');
            mensagemBox.classList.add('hidden');
          }
        };

        socket.onerror = () => showError('Erro de conex√£o com o servidor.');
      }

      connectWS();
      messageInput.focus();
      sendButton.onclick = () => enviarMensagem(prodId, nomeProd);
    }

    function enviarMensagem(prodId, prodNome) {
      const text = messageInput.value.trim();
      if (!text) return showError('Digite uma mensagem antes de enviar.');
      if (!socket || socket.readyState !== WebSocket.OPEN) return showError('Sem conex√£o com o servidor.');

      const message = {
        from: currentUser.uid,
        fromName: currentUser.displayName || 'Voc√™',
        fromPhotoURL: currentUser.photoURL || '',
        text,
        timestamp: Date.now(),
        produtoId: prodId,
        produtoNome: prodNome
      };

      socket.send(JSON.stringify(message));
      renderMessage(message);
      messageInput.value = '';
      messageInput.dispatchEvent(new Event('input')); // Para resetar o contador
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || (await signInAnonymously(auth)).user;

      const params = new URLSearchParams(location.search);
      const uidDest = params.get('para');
      const nomeDest = params.get('nome');
      const nomeProd = params.get('produto');
      const prodId = params.get('produtoId');
      const chatId = params.get('chatId');

      let otherUid, otherName, otherPhoto;

      if (chatId) {
        const chatDoc = await getDoc(doc(db, 'chats', chatId));
        if (!chatDoc.exists()) return showError('Conversa n√£o encontrada.');

        const data = chatDoc.data();
        otherUid = data.participants.find(id => id !== currentUser.uid);
        
        const otherUserDoc = await getDoc(doc(db, 'users', otherUid));
        if (otherUserDoc.exists()) {
          const otherData = otherUserDoc.data();
          otherName = otherData.name || 'Usu√°rio';
          otherPhoto = otherData.photoURL || '';
        } else {
          otherName = 'Usu√°rio';
          otherPhoto = '';
        }

        await abrirConversa(otherUid, otherName, data.produtoNome, data.produtoId, otherPhoto);

      } else if (uidDest && nomeDest && nomeProd && prodId) {
        if (uidDest === currentUser.uid) return showError('N√£o pode conversar consigo mesmo.');
        otherUid = uidDest;
        
        const otherUserDoc = await getDoc(doc(db, 'users', otherUid));
        if (otherUserDoc.exists()) {
          const otherData = otherUserDoc.data();
          otherName = otherData.name || nomeDest;
          otherPhoto = otherData.photoURL || '';
        } else {
          otherName = nomeDest;
          otherPhoto = '';
        }

        await abrirConversa(otherUid, otherName, nomeProd, prodId, otherPhoto);
      } else {
        showError('Par√¢metros de conversa inv√°lidos.');
      }
    });

    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendButton.click(); // Simula o clique para usar a mesma l√≥gica
      }
    });

    window.addEventListener('beforeunload', () => {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
    });

    let typingTimeout;

    messageInput.addEventListener('input', () => {
      const length = messageInput.value.length;
      charCounter.textContent = `${length} / 500`;

      charCounter.classList.toggle('text-red-500', length > 450);

      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: 'typing', from: currentUser.uid }));
      }

      clearTimeout(typingTimeout);

      typingTimeout = setTimeout(() => {
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: 'stopTyping', from: currentUser.uid }));
        }
      }, 2000);
    });

  </script>
</body>
</html>