<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ReMarket Sustent√°vel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    ::-webkit-scrollbar-thumb {
      background: #15803d;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #16a34a;
    }
    .line-clamp-2 {
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }
    /* Anima√ß√£o para o carrossel */
    .carousel-slide {
      transition: opacity 0.4s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 flex min-h-screen">

  <aside id="sidebar" class="bg-green-800 text-white w-64 fixed top-0 left-0 h-full shadow-lg z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
    <div class="flex items-center justify-center space-x-3 p-4 border-b border-green-700 h-20">
      <span class="text-3xl">‚ôªÔ∏è</span>
      <h1 class="text-2xl font-semibold text-white">ReMarket</h1>
    </div>
    <nav class="flex flex-col p-4 space-y-2">
      <a href="index.html" class="flex items-center space-x-3 text-white bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        <span>Home</span>
      </a>
          <nav class="flex flex-col p-4 space-y-2">
      <a href="dashboard.html" class="flex items-center space-x-3 text-white bg-green-700 px-3 py-2.5 rounded-md font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        <span>Dashboard</span>
      </a>
      <a href="register.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span>Cadastrar Recurso</span>
      </a>
      <a href="profile.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A10.97 10.97 0 0112 15c2.21 0 4.254.64 5.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <span>Profile</span>
      </a>
      <a href="conversas.html" class="flex items-center space-x-3 text-gray-200 hover:text-white hover:bg-green-700 px-3 py-2.5 rounded-md transition font-medium">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16h6m-7 4h8a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
        <span>Minhas Conversas</span>
      </a>
    </nav>
  </aside>

  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-30 hidden lg:hidden"></div>

  <div class="flex-1 flex flex-col lg:ml-64 w-full pt-20 lg:pt-0">
  
    <header class="bg-white shadow-md py-4 lg:hidden fixed top-0 left-0 right-0 z-20">
      <div class="container mx-auto flex justify-between items-center px-4 sm:px-6">
        <div class="flex items-center space-x-3">
          <span class="text-2xl">‚ôªÔ∏è</span>
          <h1 class="text-xl sm:text-2xl font-semibold text-green-700">ReMarket</h1>
        </div>
        <button id="sidebar-toggle" class="text-gray-600 hover:text-green-600 focus:outline-none" aria-label="Toggle sidebar">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
        </button>
      </div>
    </header>
    
    <header class="hidden lg:flex items-center justify-between bg-white p-4 border-b border-gray-200 h-20 shadow-sm">
        <h1 class="text-xl font-semibold text-gray-800">In√≠cio</h1>
    </header>

    <main class="flex-grow">
      <section class="bg-green-50 py-12 text-center">
        <div class="container mx-auto px-4 sm:px-6">
          <h2 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">Conectando Empresas para um Futuro Sustent√°vel</h2>
          <p class="text-base sm:text-lg text-gray-600 max-w-2xl mx-auto">
            Compartilhe recursos ociosos, reduza custos e contribua com a economia circular.
          </p>
          <a href="#products" class="mt-6 inline-block bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition text-sm shadow-md hover:shadow-lg">Descubra Recursos</a>
        </div>
      </section>

      <section class="container mx-auto px-4 sm:px-6 py-8">
        <div class="flex flex-col sm:flex-row gap-4 max-w-3xl mx-auto">
          <input id="search-input" type="text" placeholder="Buscar por nome ou categoria..." class="flex-grow px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 text-sm" aria-label="Buscar por nome ou categoria" />
          <select id="category-filter" class="px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 text-sm bg-white" aria-label="Filtrar por categoria">
            <option value="">Todas as Categorias</option>
            <option value="M√≥veis">M√≥veis</option>
            <option value="Eletr√¥nicos">Eletr√¥nicos</option>
            <option value="Equipamentos">Equipamentos</option>
            <option value="Ve√≠culos">Ve√≠culos</option>
            <option value="Outros">Outros</option>
          </select>
        </div>
      </section>

      <section id="products" class="container mx-auto px-4 sm:px-6 py-10">
        <h3 class="text-2xl sm:text-3xl font-semibold text-gray-800 mb-6">Recursos Dispon√≠veis</h3>
        
        <div id="product-loader" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="bg-white rounded-lg shadow animate-pulse">
            <div class="bg-gray-200 h-48 rounded-t-lg"></div>
            <div class="p-5"><div class="h-6 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-4 bg-gray-200 rounded w-full mb-4"></div><div class="h-4 bg-gray-200 rounded w-1/2"></div></div>
          </div>
          <div class="bg-white rounded-lg shadow animate-pulse">
            <div class="bg-gray-200 h-48 rounded-t-lg"></div>
            <div class="p-5"><div class="h-6 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-4 bg-gray-200 rounded w-full mb-4"></div><div class="h-4 bg-gray-200 rounded w-1/2"></div></div>
          </div>
          <div class="bg-white rounded-lg shadow animate-pulse">
            <div class="bg-gray-200 h-48 rounded-t-lg"></div>
            <div class="p-5"><div class="h-6 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-4 bg-gray-200 rounded w-full mb-4"></div><div class="h-4 bg-gray-200 rounded w-1/2"></div></div>
          </div>
        </div>
        
        <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" aria-live="polite" aria-relevant="additions removals"></div>
      </section>
    </main>

    <footer class="bg-green-800 text-white text-center py-4 mt-auto">
      <p class="text-sm">&copy; 2025 ReMarket Sustent√°vel ‚Äî Um futuro mais verde üå±</p>
    </footer>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCexikls640kZgxsknXUQpHZiNEPwRf4xg",
        authDomain: "encurta-c3642.firebaseapp.com",
        projectId: "encurta-c3642",
        storageBucket: "encurta-c3642.appspot.com",
        messagingSenderId: "365232410104",
        appId: "1:365232410104:web:d67b449427153593ec5a0d",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const productList = document.getElementById("product-list");
    const productLoader = document.getElementById("product-loader");
    const searchInput = document.getElementById("search-input");
    const categoryFilter = document.getElementById("category-filter");
    const sidebarToggle = document.getElementById("sidebar-toggle");
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebar-overlay");

    let loadedProducts = [];
    let currentUser = null;

    function createImageCarousel(images, productName) {
        if (!images || images.length === 0) {
            return `<img src="https://placehold.co/600x400/e2e8f0/4a5568?text=Sem+Imagem" alt="Imagem indispon√≠vel para ${productName}" class="w-full h-48 object-cover rounded-t-lg" />`;
        }
        if (images.length === 1) {
            return `<img src="${images[0]}" alt="Imagem de ${productName}" class="w-full h-48 object-cover rounded-t-lg" onerror="this.onerror=null;this.src='https://placehold.co/600x400?text=Imagem+Indispon√≠vel';" />`;
        }

        const carouselId = `carousel-${Math.random().toString(36).substr(2, 9)}`;
        const slides = images.map((img, i) => `
            <div class="carousel-slide absolute inset-0 w-full h-full opacity-0 ${i === 0 ? 'opacity-100' : ''}" data-index="${i}">
                <img src="${img}" alt="Imagem ${i + 1} de ${productName}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400?text=Imagem+Indispon√≠vel';" />
            </div>`).join('');
        const counter = `<div class="carousel-counter absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-md z-10">1 / ${images.length}</div>`;
        const controls = `
            <button class="carousel-prev absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-40 text-white p-1 rounded-full hover:bg-opacity-60 focus:outline-none z-10" aria-label="Anterior">&lt;</button>
            <button class="carousel-next absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-40 text-white p-1 rounded-full hover:bg-opacity-60 focus:outline-none z-10" aria-label="Pr√≥ximo">&gt;</button>`;
        const container = document.createElement("div");
        container.id = carouselId;
        container.className = "relative overflow-hidden rounded-t-lg h-48";
        container.innerHTML = slides + controls + counter;
        setTimeout(() => {
            const carousel = document.getElementById(carouselId);
            if (!carousel) return;
            const slides = carousel.querySelectorAll(".carousel-slide");
            const counterEl = carousel.querySelector(".carousel-counter");
            let currentIndex = 0;
            function showSlide(index) {
                if (counterEl) { counterEl.textContent = `${index + 1} / ${slides.length}`; }
                slides.forEach((slide, i) => {
                    slide.classList.toggle('opacity-100', i === index);
                    slide.classList.toggle('opacity-0', i !== index);
                });
                currentIndex = index;
            }
            carousel.querySelector(".carousel-prev").addEventListener("click", () => {
                let newIndex = currentIndex - 1;
                if (newIndex < 0) newIndex = slides.length - 1;
                showSlide(newIndex);
            });
            carousel.querySelector(".carousel-next").addEventListener("click", () => {
                let newIndex = currentIndex + 1;
                if (newIndex >= slides.length) newIndex = 0;
                showSlide(newIndex);
            });
        }, 0);
        return container.outerHTML;
    }

    function renderProdutos(filtro = "", categoria = "") {
        const termo = filtro.toLowerCase().trim();
        const filtrados = loadedProducts.filter((p) => {
            const nome = p.nome ? p.nome.toLowerCase() : "";
            const desc = p.descricao ? p.descricao.toLowerCase() : "";
            const cat = p.categoria ? p.categoria.toLowerCase() : "";
            return (
                (nome.includes(termo) || desc.includes(termo) || cat.includes(termo)) &&
                (categoria === "" || p.categoria === categoria)
            );
        });

        productList.innerHTML = "";
        if (filtrados.length === 0) {
            productList.innerHTML = `<p class="text-gray-500 col-span-full text-center">Nenhum recurso encontrado com os filtros aplicados.</p>`;
            return;
        }

        filtrados.forEach((p) => {
            const imagens = Array.isArray(p.imagens) ? p.imagens.filter(Boolean) : (p.imagem ? [p.imagem] : []);
            const userName = p.userName || "Usu√°rio An√¥nimo";
            const precoFormatado = (p.valor && p.valor > 0) ? new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(p.valor) : 'A combinar';
            
            // --- L√≥gica da Descri√ß√£o "Ver mais" ---
            const descLimit = 120;
            const descricao = p.descricao || "Sem descri√ß√£o";
            const isDescLong = descricao.length > descLimit;
            const descId = `desc-${p.id}`;
            let descriptionHTML;
            if (isDescLong) {
                descriptionHTML = `
                    <div class="flex flex-col items-start">
                        <p id="${descId}" class="line-clamp-3">
                            <span class="font-semibold text-gray-800">Descri√ß√£o:</span>
                            ${descricao}
                        </p>
                        <button onclick="toggleClamp('${descId}', this)" class="text-green-600 hover:text-green-800 font-semibold text-sm mt-1">
                            Ver mais
                        </button>
                    </div>`;
            } else {
                descriptionHTML = `<p><span class="font-semibold text-gray-800">Descri√ß√£o:</span> ${descricao}</p>`;
            }
            // --- Fim da L√≥gica da Descri√ß√£o ---

            const card = document.createElement("div");
            card.className = "bg-white rounded-2xl shadow-md hover:shadow-lg transition flex flex-col overflow-hidden border border-gray-100";
            card.innerHTML = `
                <div class="relative group">
                    ${createImageCarousel(imagens, p.nome)}
                </div>
                <div class="p-5 flex flex-col flex-grow">
                    <h4 class="text-lg font-semibold text-gray-800 mb-1">${p.nome || "Sem nome"}</h4>
                    <div class="my-4 text-center">
                        <p class="text-3xl font-bold text-green-700">${precoFormatado}</p>
                    </div>
                    <div class="flex flex-wrap gap-2 text-xs font-medium text-gray-600 mb-4">
                        <span class="bg-gray-100 px-3 py-1 rounded-full">${p.categoria || "Sem categoria"}</span>
                        <span class="bg-gray-100 px-3 py-1 rounded-full">${p.tipo || "Sem tipo"}</span>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-3 text-sm text-gray-700 space-y-2 border border-gray-100 mb-4">
                        ${descriptionHTML}
                        <p><span class="font-semibold text-gray-800">Quantidade:</span> ${p.quantidade || "1"}</p>
                        <p><span class="font-semibold text-gray-800">Endere√ßo:</span> ${p.endereco || "N√£o informado"}</p>
                        <p><span class="font-semibold text-gray-800">Telefone:</span> ${p.telefone || "N√£o informado"}</p>
                    </div>
                    <div class="mt-auto pt-4 border-t border-gray-100 space-y-2">
                        <button onclick="verProduto('${p.id}')"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm shadow">
                            Ver Produto
                        </button>
                        <button onclick="iniciarChat('${p.telefone || ''}', '${userName}', '${p.nome}', '${p.usuarioId || ''}', '${p.id}')"
                                class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm shadow ${!p.usuarioId ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${!p.usuarioId ? 'disabled' : ''}>
                            Chamar no Chat
                        </button>
                    </div>
                </div>`;
            productList.appendChild(card);
        });
    }

    window.verProduto = function(produtoId) {
        const params = new URLSearchParams({ id: produtoId });
        window.open(`product.html?${params.toString()}`, '_blank');
    };

    window.iniciarChat = function(telefone, nome, produto, uidDestinatario, produtoId) {
        if (!uidDestinatario) { alert('N√£o √© poss√≠vel iniciar o chat: informa√ß√µes do anunciante incompletas.'); return; }
        if (!currentUser) { alert('Voc√™ precisa estar logado para iniciar um chat.'); return; }
        if (uidDestinatario === currentUser.uid) { alert('Voc√™ n√£o pode iniciar um chat consigo mesmo.'); return; }
        const params = new URLSearchParams({ nome, produto, para: uidDestinatario, produtoId });
        window.open(`chat.html?${params.toString()}`, '_blank');
    };

    // --- Fun√ß√£o para o "Ver mais" da descri√ß√£o ---
    window.toggleClamp = function(elementId, button) {
        const element = document.getElementById(elementId);
        if (!element) return;
        element.classList.toggle('line-clamp-3');
        button.textContent = element.classList.contains('line-clamp-3') ? 'Ver mais' : 'Ver menos';
    }

    function toggleSidebar() {
        sidebar.classList.toggle("translate-x-0");
        sidebar.classList.toggle("-translate-x-full");
        sidebarOverlay.classList.toggle("hidden");
    }

    sidebarToggle.addEventListener("click", toggleSidebar);
    sidebarOverlay.addEventListener("click", toggleSidebar);

    onAuthStateChanged(auth, async (user) => {
        currentUser = user || (await signInAnonymously(auth)).user;
    });

    const ref = query(collection(db, "produtos"), orderBy("createdAt", "desc"));
    onSnapshot(ref, (snapshot) => {
        productLoader.style.display = 'none';
        loadedProducts = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        renderProdutos(searchInput.value, categoryFilter.value);
    }, (error) => {
        console.error('Erro ao carregar produtos:', error);
        productLoader.style.display = 'none';
        productList.innerHTML = `<p class="text-red-500 col-span-full text-center">Erro ao carregar recursos. Tente novamente mais tarde.</p>`;
    });

    searchInput.addEventListener("input", () => renderProdutos(searchInput.value, categoryFilter.value));
    categoryFilter.addEventListener("change", () => renderProdutos(searchInput.value, categoryFilter.value));
</script>
</body>
</html>